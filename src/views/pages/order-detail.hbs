{{!--
  Order Detail Page
  Based on design template: orderDetails.html
  User Story 3: View and Track Orders
--}}
<div class="relative flex h-auto min-h-screen w-full flex-col group/design-root overflow-x-hidden">
<main class="layout-container flex h-full grow flex-col">
  <div class="flex flex-1 justify-center py-5">
    <div class="flex flex-col w-full max-w-7xl flex-1 px-4 sm:px-6 lg:px-8">

      {{! Breadcrumbs and Back Button }}
      <div class="flex flex-wrap items-center justify-between gap-4 mb-8">
        <div class="flex items-center gap-2 text-sm text-neutral-gray-text dark:text-gray-400">
          <a class="text-primary hover:text-corporate-blue transition-colors font-medium" href="/orders">Orders</a>
          <span class="material-symbols-outlined text-base text-neutral-gray-text dark:text-gray-400">chevron_right</span>
          <span class="font-medium text-[#111418] dark:text-gray-200">Order #{{order.orderNumber}}</span>
        </div>
        <a href="/orders"
          class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg h-10 px-4 bg-white dark:bg-gray-800 border-2 border-primary/20 dark:border-primary/30 text-primary dark:text-primary text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/5 dark:hover:bg-primary/10 hover:border-primary/40 transition-all">
          <span class="material-symbols-outlined">arrow_back</span>
          <span class="truncate">Back to Orders</span>
        </a>
      </div>

      {{! Page Heading and Actions }}
      <div class="flex flex-wrap items-start justify-between gap-4 mb-8">
        <div class="flex flex-col gap-2">
          <h1 class="text-4xl font-black leading-tight tracking-[-0.033em] text-[#111418] dark:text-white">
            Order #{{order.orderNumber}}
          </h1>
          <div class="flex items-center gap-2">
            <span class="font-medium text-neutral-gray-text dark:text-gray-400">Status:</span>
            <span class="inline-flex items-center rounded-full px-3 py-1 text-sm font-semibold
              {{#eq order.status 'received'}}bg-status-info/10 text-status-info{{/eq}}
              {{#eq order.status 'in_confirmation'}}bg-status-warning/10 text-status-warning{{/eq}}
              {{#eq order.status 'confirmed'}}bg-status-success/10 text-status-success{{/eq}}
              {{#eq order.status 'in_shipping'}}bg-status-info/10 text-status-info{{/eq}}
              {{#eq order.status 'shipped'}}bg-status-info/10 text-status-info{{/eq}}
              {{#eq order.status 'delivered'}}bg-status-success/10 text-status-success{{/eq}}
              {{#eq order.status 'cancelled'}}bg-status-error/10 text-status-error{{/eq}}
              {{#eq order.status 'pending'}}bg-status-warning/10 text-status-warning{{/eq}}
              {{#eq order.status 'processing'}}bg-status-warning/10 text-status-warning{{/eq}}">
              {{order.statusDisplay}}
            </span>
          </div>
        </div>
        <div class="flex flex-1 sm:flex-initial justify-start sm:justify-end gap-3 flex-wrap">
          {{#if order.hasReceipt}}
            <a href="/api/orders/{{order.id}}/receipt"
              download
              class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-corporate-blue text-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-opacity-90">
              <span class="truncate">Download Invoice</span>
            </a>
          {{/if}}
          <button onclick="reorder('{{order.id}}')"
            class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-white dark:bg-gray-800 border-2 border-primary/30 dark:border-primary/40 text-primary dark:text-primary text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/10 dark:hover:bg-primary/20 hover:border-primary/50 transition-all">
            <span class="material-symbols-outlined text-base mr-1">refresh</span>
            <span class="truncate">Reorder</span>
          </button>
          <button onclick="requestReturn('{{order.id}}')"
            class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-white dark:bg-gray-800 border-2 border-status-warning/30 dark:border-status-warning/40 text-status-warning dark:text-status-warning text-sm font-bold leading-normal tracking-[0.015em] hover:bg-status-warning/10 dark:hover:bg-status-warning/20 hover:border-status-warning/50 transition-all">
            <span class="material-symbols-outlined text-base mr-1">undo</span>
            <span class="truncate">Request Return</span>
          </button>
        </div>
      </div>

      {{! Main Content Grid }}
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        {{! Left Column - Order Summary, Shipping, Billing }}
        <div class="lg:col-span-1 flex flex-col gap-6">

          {{! Order Summary Card }}
          <section class="bg-gradient-to-br from-white to-neutral-gray-bg/50 dark:from-gray-800 dark:to-gray-900 border-2 border-primary/10 dark:border-primary/20 rounded-xl p-6 flex flex-col gap-4 shadow-sm">
            <h2 class="text-lg font-bold text-[#111418] dark:text-white flex items-center gap-2">
              <span class="material-symbols-outlined text-primary text-xl">receipt_long</span>
              Order Summary
            </h2>
            <dl class="space-y-3 text-sm">
              <div class="flex justify-between py-2 border-b border-neutral-gray-border/50 dark:border-gray-700/50">
                <dt class="text-neutral-gray-text dark:text-gray-400">Order Date</dt>
                <dd class="font-medium text-[#111418] dark:text-white">{{order.orderDate}}</dd>
            </div>
              <div class="flex justify-between py-2 border-b border-neutral-gray-border/50 dark:border-gray-700/50">
                <dt class="text-neutral-gray-text dark:text-gray-400">Payment Method</dt>
                <dd class="font-medium text-primary dark:text-primary">Net 30 Terms</dd>
          </div>
              <div class="flex justify-between text-base pt-2">
                <dt class="text-neutral-gray-text dark:text-gray-400 font-normal">Order Total</dt>
                <dd class="font-bold text-lg text-corporate-blue dark:text-corporate-blue">${{order.totalFormatted}}</dd>
                    </div>
            </dl>
          </section>

          {{! Shipping Details }}
          <section class="bg-gradient-to-br from-white to-blue-50/30 dark:from-gray-800 dark:to-blue-900/10 border-2 border-status-info/20 dark:border-status-info/30 rounded-xl p-6 flex flex-col gap-4 shadow-sm">
            <h2 class="text-lg font-bold text-[#111418] dark:text-white flex items-center gap-2">
              <span class="material-symbols-outlined text-status-info text-xl">local_shipping</span>
              Shipping Details
            </h2>
            <div class="text-sm space-y-3">
              <div class="font-medium text-[#111418] dark:text-white">
                {{#if order.shippingAddress.contactName}}
                  <p>{{order.shippingAddress.contactName}}</p>
                {{/if}}
                <p>{{order.shippingAddress.street}}</p>
                {{#if order.shippingAddress.addressLine2}}
                  <p>{{order.shippingAddress.addressLine2}}</p>
                {{/if}}
                <p>{{order.shippingAddress.city}}, {{order.shippingAddress.state}} {{order.shippingAddress.postalCode}}</p>
                <p>{{order.shippingAddress.country}}</p>
                  </div>
              <dl class="space-y-2">
                <div class="flex justify-between">
                  <dt class="text-neutral-gray-text dark:text-gray-400">Method</dt>
                  <dd class="font-medium text-[#111418] dark:text-white">Freight Standard</dd>
                  </div>
                <div class="flex justify-between items-center">
                  <dt class="text-neutral-gray-text dark:text-gray-400">Tracking</dt>
                  <dd class="font-medium text-[#111418] dark:text-white">
                    {{#if order.trackingNumber}}
                      <a class="text-status-info hover:text-corporate-blue hover:underline font-semibold transition-colors" href="#">{{order.trackingNumber}}</a>
                    {{else}}
                      <span class="text-neutral-gray-text dark:text-gray-400 italic">Unavailable</span>
                    {{/if}}
                  </dd>
                </div>
              </dl>
            </div>
          </section>

          {{! Billing Details }}
          <section class="bg-gradient-to-br from-white to-green-50/30 dark:from-gray-800 dark:to-green-900/10 border-2 border-status-success/20 dark:border-status-success/30 rounded-xl p-6 flex flex-col gap-4 shadow-sm">
            <h2 class="text-lg font-bold text-[#111418] dark:text-white flex items-center gap-2">
              <span class="material-symbols-outlined text-status-success text-xl">account_balance</span>
              Billing Details
            </h2>
            <div class="text-sm space-y-3">
              <div class="font-medium text-[#111418] dark:text-white">
                {{#if order.billingAddress.contactName}}
                  <p>{{order.billingAddress.contactName}}</p>
                {{/if}}
                <p>{{order.billingAddress.street}}</p>
                {{#if order.billingAddress.addressLine2}}
                  <p>{{order.billingAddress.addressLine2}}</p>
                {{/if}}
                <p>{{order.billingAddress.city}}, {{order.billingAddress.state}} {{order.billingAddress.postalCode}}</p>
                <p>{{order.billingAddress.country}}</p>
              </div>
              <dl>
                <div class="flex justify-between items-center">
                  <dt class="text-neutral-gray-text dark:text-gray-400">Payment Status</dt>
                  <dd>
                    <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold
                      {{#eq order.status 'delivered'}}bg-status-success/10 text-status-success{{/eq}}
                      {{#eq order.status 'cancelled'}}bg-status-error/10 text-status-error{{/eq}}
                      {{#ifCond order.status '===' 'delivered'}}{{else}}{{#ifCond order.status '===' 'cancelled'}}{{else}}bg-status-warning/10 text-status-warning{{/ifCond}}{{/ifCond}}">
                      {{#eq order.status 'delivered'}}Paid{{/eq}}
                      {{#eq order.status 'cancelled'}}Cancelled{{/eq}}
                      {{#ifCond order.status '===' 'delivered'}}{{else}}{{#ifCond order.status '===' 'cancelled'}}{{else}}Pending{{/ifCond}}{{/ifCond}}
                    </span>
                  </dd>
                </div>
              </dl>
          </div>
          </section>

        </div>

        {{! Right Column - Order Progress and Items }}
        <div class="lg:col-span-2 flex flex-col gap-8">

          {{! Order Progress Tracker }}
          <section class="bg-gradient-to-br from-white to-primary/5 dark:from-gray-800 dark:to-primary/10 border-2 border-primary/20 dark:border-primary/30 rounded-xl p-6 shadow-sm">
            <h2 class="text-lg font-bold text-[#111418] dark:text-white mb-6 flex items-center gap-2">
              <span class="material-symbols-outlined text-primary text-xl">timeline</span>
              Order Progress
            </h2>
            <div class="grid grid-cols-[auto_1fr] gap-x-4">
              {{! Order Placed - Always completed }}
              <div class="flex flex-col items-center gap-1.5 pt-1.5">
                <div class="text-status-success flex items-center justify-center rounded-full bg-status-success/20 dark:bg-status-success/30 size-10 shadow-md border-2 border-status-success/30">
                  <span class="material-symbols-outlined text-xl">check_circle</span>
                </div>
                <div class="w-[2px] bg-gradient-to-b from-status-success/50 to-status-warning/30 dark:from-status-success/30 dark:to-status-warning/20 h-full"></div>
              </div>
              <div class="flex flex-1 flex-col pb-8">
                <p class="font-bold text-base leading-normal text-[#111418] dark:text-white">Order Placed</p>
                <p class="text-neutral-gray-text dark:text-gray-400 text-sm leading-normal">{{order.orderDate}}</p>
              </div>

              {{! Processing/Confirmed - Show based on status }}
              <div class="flex flex-col items-center gap-1.5">
                <div class="w-[2px] {{#if order.isProcessingActive}}bg-gradient-to-b from-status-success/50 to-status-warning/50{{else}}bg-neutral-gray-border dark:bg-gray-700{{/if}} h-1.5"></div>
                <div class="flex items-center justify-center rounded-full size-10
                  {{#if order.isProcessingActive}}
                    text-status-warning bg-status-warning/20 dark:bg-status-warning/30 shadow-md border-2 border-status-warning/30
                  {{else}}
                    text-neutral-gray-text dark:text-gray-400 bg-neutral-gray-bg dark:bg-gray-700 border border-neutral-gray-border dark:border-gray-600
                  {{/if}}">
                  <span class="material-symbols-outlined text-xl">hourglass_top</span>
                </div>
                <div class="w-[2px] {{#if order.isProcessingActive}}bg-gradient-to-b from-status-warning/50 to-status-info/30{{else}}bg-neutral-gray-border dark:bg-gray-700{{/if}} h-full"></div>
              </div>
              <div class="flex flex-1 flex-col pb-8">
                <p class="text-base leading-normal
                  {{#if order.isProcessingActive}}
                    font-bold text-[#111418] dark:text-white
                  {{else}}
                    text-neutral-gray-text dark:text-gray-400 font-medium
                  {{/if}}">
                  Processing
                </p>
                {{#if order.isProcessingActive}}
                  {{#ifCond order.status '===' 'in_confirmation'}}
                    <p class="text-neutral-gray-text dark:text-gray-400 text-sm leading-normal">{{order.orderDate}}</p>
                  {{/ifCond}}
                  {{#ifCond order.status '===' 'confirmed'}}
                    <p class="text-neutral-gray-text dark:text-gray-400 text-sm leading-normal">{{order.orderDate}}</p>
                  {{/ifCond}}
                {{/if}}
              </div>

              {{! Shipped - Show based on status }}
              <div class="flex flex-col items-center gap-1.5">
                <div class="w-[2px] {{#if order.isShippedActive}}bg-gradient-to-b from-status-warning/50 to-status-info/50{{else}}bg-neutral-gray-border dark:bg-gray-700{{/if}} h-1.5"></div>
                <div class="flex items-center justify-center rounded-full size-10
                  {{#if order.isShippedActive}}
                    text-status-info bg-status-info/20 dark:bg-status-info/30 shadow-md border-2 border-status-info/30
                  {{else}}
                    text-neutral-gray-text dark:text-gray-400 bg-neutral-gray-bg dark:bg-gray-700 border border-neutral-gray-border dark:border-gray-600
                  {{/if}}">
                  <span class="material-symbols-outlined text-xl">local_shipping</span>
                </div>
                <div class="w-[2px] {{#if order.isShippedActive}}bg-gradient-to-b from-status-info/50 to-status-success/30{{else}}bg-neutral-gray-border dark:bg-gray-700{{/if}} h-full"></div>
              </div>
              <div class="flex flex-1 flex-col pb-8">
                <p class="text-base leading-normal
                  {{#if order.isShippedActive}}
                    font-bold text-[#111418] dark:text-white
                  {{else}}
                    text-neutral-gray-text dark:text-gray-400 font-medium
                  {{/if}}">
                  Shipped
                </p>
                {{#ifCond order.status '===' 'shipped'}}
                  <p class="text-neutral-gray-text dark:text-gray-400 text-sm leading-normal">{{order.orderDate}}</p>
                {{/ifCond}}
              </div>

              {{! Delivered - Show based on status }}
              <div class="flex flex-col items-center gap-1.5">
                <div class="w-[2px] {{#eq order.status 'delivered'}}bg-gradient-to-b from-status-info/50 to-status-success/50{{else}}bg-neutral-gray-border dark:bg-gray-700{{/eq}} h-1.5"></div>
                <div class="flex items-center justify-center rounded-full size-10
                  {{#eq order.status 'delivered'}}
                    text-status-success bg-status-success/20 dark:bg-status-success/30 shadow-md border-2 border-status-success/30
                  {{else}}
                    text-neutral-gray-text dark:text-gray-400 bg-neutral-gray-bg dark:bg-gray-700 border border-neutral-gray-border dark:border-gray-600
                  {{/eq}}">
                  <span class="material-symbols-outlined text-xl">inventory_2</span>
                </div>
              </div>
              <div class="flex flex-1 flex-col">
                <p class="text-base leading-normal
                  {{#eq order.status 'delivered'}}
                    font-bold text-[#111418] dark:text-white
                  {{else}}
                    text-neutral-gray-text dark:text-gray-400 font-medium
                  {{/eq}}">
                  Delivered
                </p>
                {{#if (eq order.status 'delivered')}}
                  <p class="text-neutral-gray-text dark:text-gray-400 text-sm leading-normal">{{order.orderDate}}</p>
                {{/if}}
              </div>
            </div>
          </section>

          {{! Items Purchased Table }}
          <section class="bg-gradient-to-br from-white to-neutral-gray-bg/30 dark:from-gray-800 dark:to-gray-900 border-2 border-primary/10 dark:border-primary/20 rounded-xl shadow-sm">
            <div class="p-6 border-b border-neutral-gray-border/50 dark:border-gray-700/50">
              <h2 class="text-lg font-bold text-[#111418] dark:text-white flex items-center gap-2">
                <span class="material-symbols-outlined text-primary text-xl">shopping_bag</span>
                Items Purchased
              </h2>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm text-left">
                <thead class="bg-gradient-to-r from-primary/10 to-primary/5 dark:from-primary/20 dark:to-primary/10 text-xs text-neutral-gray-text dark:text-gray-400 uppercase">
                  <tr>
                    <th class="px-6 py-3 w-2/5 font-semibold" scope="col">Product</th>
                    <th class="px-6 py-3 text-center font-semibold" scope="col">Quantity</th>
                    <th class="px-6 py-3 text-right font-semibold" scope="col">Unit Price</th>
                    <th class="px-6 py-3 text-right font-semibold" scope="col">Total</th>
                  </tr>
                </thead>
                <tbody>
                  {{#each order.items}}
                    <tr class="border-b border-neutral-gray-border/30 dark:border-gray-700/50 hover:bg-primary/5 dark:hover:bg-primary/10 transition-colors">
                      <td class="px-6 py-4 font-medium whitespace-nowrap">
                        <div class="flex items-center gap-4">
                          <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-lg size-12 flex-shrink-0 border-2 border-primary/20 shadow-sm"
                            data-alt="{{this.productName}}"
                            style="background-image: url('https://via.placeholder.com/48?text={{this.productName}}');">
                          </div>
                          <div>
                            <p class="font-bold text-[#111418] dark:text-gray-200">{{this.productName}}</p>
                            <p class="text-xs text-neutral-gray-text dark:text-gray-400">SKU: <span class="font-mono text-primary/80">{{this.sku}}</span></p>
          </div>
          </div>
                      </td>
                      <td class="px-6 py-4 text-center">
                        <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-primary/10 dark:bg-primary/20 text-primary dark:text-primary font-semibold">{{this.quantity}}</span>
                      </td>
                      <td class="px-6 py-4 text-right font-semibold text-[#111418] dark:text-white">${{this.unitPrice}}</td>
                      <td class="px-6 py-4 text-right font-bold text-corporate-blue dark:text-corporate-blue">${{this.subtotal}}</td>
                    </tr>
                  {{/each}}
                </tbody>
              </table>
            </div>
            <div class="p-6 flex justify-end bg-gradient-to-r from-neutral-gray-bg/50 to-transparent dark:from-gray-900/50">
              <div class="w-full max-w-sm space-y-3 text-sm">
                <div class="flex justify-between py-2">
                  <span class="text-neutral-gray-text dark:text-gray-400">Subtotal</span>
                  <span class="font-medium text-[#111418] dark:text-white">${{order.subtotalFormatted}}</span>
                </div>
                <div class="flex justify-between py-2">
                  <span class="text-neutral-gray-text dark:text-gray-400">Shipping</span>
                  <span class="font-medium text-status-info dark:text-status-info">${{order.shippingFormatted}}</span>
                </div>
                <div class="flex justify-between py-2">
                  <span class="text-neutral-gray-text dark:text-gray-400">Taxes</span>
                  <span class="font-medium text-status-warning dark:text-status-warning">${{order.taxFormatted}}</span>
                </div>
                <div class="border-t-2 border-primary/20 dark:border-primary/30 my-3"></div>
                <div class="flex justify-between text-lg font-bold pt-2">
                  <span class="text-[#111418] dark:text-white">Grand Total</span>
                  <span class="text-corporate-blue dark:text-corporate-blue text-xl">${{order.totalFormatted}}</span>
                </div>
              </div>
            </div>
          </section>

        </div>
      </div>

    </div>
  </div>
</main>
</div>

<script>
async function reorder(orderId) {
  try {
    const response = await fetch(`/api/orders/${orderId}/reorder`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      credentials: 'include',
    });

    if (response.ok) {
      const data = await response.json();
      // Redirect to cart
      window.location.href = '/checkout';
    } else {
      alert('Failed to reorder. Please try again.');
    }
  } catch (error) {
    console.error('Reorder error:', error);
    alert('An error occurred. Please try again.');
  }
}

function requestReturn(orderId) {
  // TODO: Implement return request functionality
  alert('Return request functionality coming soon. Please contact support for returns.');
}
</script>
