{{!--
  Order History Page
  User Story 3: View and Track Orders
--}}
<div class="relative flex h-auto min-h-screen w-full flex-col group/design-root overflow-x-hidden">
<main class="layout-container flex h-full grow flex-col">
  <div class="flex flex-1 justify-center py-5">
    <div class="flex flex-col w-full max-w-7xl flex-1 px-4 sm:px-6 lg:px-8">

      {{! Breadcrumbs }}
      {{> breadcrumbs items=breadcrumbs}}

      {{! Page Header }}
      <div class="flex flex-col gap-3 mt-6 mb-8">
        <h1 class="text-slate-800 dark:text-white text-4xl font-black leading-tight tracking-[-0.033em]">
          Order History
        </h1>
        <p class="text-slate-500 dark:text-slate-400 text-base font-normal leading-normal">
          View and track all your orders
        </p>
      </div>

      {{#if orders}}
        {{! Orders List }}
        <div class="flex flex-col gap-4">
          {{#each orders}}
            <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6 hover:shadow-lg transition-shadow">
              <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">

                {{! Order Info }}
                <div class="flex-1">
                  <div class="flex items-center gap-3 mb-2">
                    <h3 class="text-lg font-semibold text-slate-800 dark:text-white">
                      Order #{{orderNumber}}
                    </h3>
                    <span class="px-3 py-1 rounded-full text-xs font-semibold
                      {{#ifEquals status 'pending'}}bg-yellow-100 dark:bg-yellow-900/50 text-yellow-700 dark:text-yellow-300{{/ifEquals}}
                      {{#ifEquals status 'confirmed'}}bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300{{/ifEquals}}
                      {{#ifEquals status 'shipped'}}bg-purple-100 dark:bg-purple-900/50 text-purple-700 dark:text-purple-300{{/ifEquals}}
                      {{#ifEquals status 'delivered'}}bg-success/20 text-success{{/ifEquals}}
                      {{#ifEquals status 'cancelled'}}bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300{{/ifEquals}}">
                      {{statusDisplay}}
                    </span>
                  </div>

                  <div class="flex flex-wrap gap-4 text-sm text-slate-600 dark:text-slate-400">
                    <span class="flex items-center gap-1">
                      <span class="material-symbols-outlined text-lg">calendar_today</span>
                      {{orderDate}}
                    </span>
                    <span class="flex items-center gap-1">
                      <span class="material-symbols-outlined text-lg">shopping_bag</span>
                      {{itemCount}} item{{#unless (ifCond itemCount "===" 1)}}s{{/unless}}
                    </span>
                    <span class="flex items-center gap-1">
                      <span class="material-symbols-outlined text-lg">payments</span>
                      ${{totalFormatted}}
                    </span>
                    {{#if poNumber}}
                      <span class="flex items-center gap-1">
                        <span class="material-symbols-outlined text-lg">description</span>
                        PO: {{poNumber}}
                      </span>
                    {{/if}}
                  </div>
                </div>

                {{! Actions }}
                <div class="flex flex-col sm:flex-row gap-2">
                  <a href="/orders/{{id}}"
                    class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg border-2 border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 font-semibold hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                    <span class="material-symbols-outlined text-lg">visibility</span>
                    View Details
                  </a>
                  <button onclick="reorder('{{id}}')"
                    class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-primary text-white font-semibold hover:bg-primary/90 transition-colors">
                    <span class="material-symbols-outlined text-lg">shopping_cart</span>
                    Reorder
                  </button>
                </div>
              </div>
            </div>
          {{/each}}
        </div>

        {{! Pagination }}
        {{#if pagination}}
          <div class="flex items-center justify-center gap-2 mt-8">
            {{#if pagination.hasPrev}}
              <a href="/orders?page={{math pagination.page "-" 1}}&limit={{pagination.limit}}"
                class="px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                Previous
              </a>
            {{/if}}

            <span class="px-4 py-2 text-slate-600 dark:text-slate-400">
              Page {{pagination.page}} of {{pagination.totalPages}}
            </span>

            {{#if pagination.hasNext}}
              <a href="/orders?page={{math pagination.page "+" 1}}&limit={{pagination.limit}}"
                class="px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                Next
              </a>
            {{/if}}
          </div>
        {{/if}}

      {{else}}
        {{! Empty State }}
        <div class="flex flex-col items-center justify-center py-16 px-4">
          <span class="material-symbols-outlined text-6xl text-slate-400 dark:text-slate-600 mb-4">
            shopping_bag
          </span>
          <h3 class="text-2xl font-bold text-slate-800 dark:text-white mb-2">
            No Orders Yet
          </h3>
          <p class="text-slate-600 dark:text-slate-400 text-center mb-6">
            You haven't placed any orders yet. Start shopping to see your order history here.
          </p>
          <a href="/products"
            class="px-6 py-3 rounded-lg bg-primary text-white font-semibold hover:bg-primary/90 transition-colors">
            Browse Products
          </a>
        </div>
      {{/if}}

    </div>
  </div>
</main>
</div>

<script>
async function reorder(orderId) {
  try {
    const response = await fetch(`/api/orders/${orderId}/reorder`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        // TODO: Add authentication header when Keycloak integration is ready
      },
    });

    if (response.ok) {
      const data = await response.json();
      // Redirect to cart
      window.location.href = '/cart';
    } else {
      alert('Failed to reorder. Please try again.');
    }
  } catch (error) {
    console.error('Reorder error:', error);
    alert('An error occurred. Please try again.');
  }
}
</script>

