{{> header}}

<main class="flex-1 bg-background-light dark:bg-background-dark">
    <div class="page-container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">Order History</h1>
            <p class="page-subtitle">View and track all your orders</p>
        </div>

        <!-- Orders List -->
        <div class="space-y-4">
            {{#each orders}}
                <div class="card hover:shadow-lg transition-shadow">
                    <a href="/orders/{{this.id}}" class="block p-6">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <h3 class="text-lg font-semibold text-text-headings dark:text-text-headings-dark">
                                        Order #{{this.orderNumber}}
                                    </h3>
                                    <span class="product-badge {{#if (eq this.status 'delivered')}}badge-success{{else if (eq this.status 'cancelled')}}badge-danger{{else if (eq this.status 'processing')}}badge-info{{else}}badge-warning{{/if}}">
                                        {{this.status}}
                                    </span>
                                </div>
                                <p class="text-sm text-text-light dark:text-text-dark">
                                    Placed on {{this.date}} â€¢ {{this.itemCount}} items
                                </p>
                            </div>
                            <div class="flex items-center gap-6">
                                <div class="text-right">
                                    <p class="text-sm text-text-light dark:text-text-dark mb-1">Total Amount</p>
                                    <p class="text-2xl font-bold text-primary dark:text-secondary">
                                        ${{this.total}}
                                    </p>
                                </div>
                                <span class="material-symbols-outlined text-text-light dark:text-text-dark">
                                    chevron_right
                                </span>
                            </div>
                        </div>

                        <!-- Order Items Preview -->
                        <div class="flex gap-3 overflow-x-auto pb-2">
                            {{#each this.items}}
                                <div class="flex-shrink-0 w-16 h-16 rounded-lg overflow-hidden bg-gray-100 dark:bg-gray-800">
                                    <img src="{{this.product.image}}" alt="{{this.product.name}}" class="w-full h-full object-cover">
                                </div>
                            {{/each}}
                            {{#if (gt this.itemCount 4)}}
                                <div class="flex-shrink-0 w-16 h-16 rounded-lg bg-gray-100 dark:bg-gray-800 flex items-center justify-center">
                                    <span class="text-xs font-semibold text-text-light dark:text-text-dark">+{{subtract this.itemCount 4}}</span>
                                </div>
                            {{/if}}
                        </div>

                        <!-- Quick Actions -->
                        <div class="flex gap-3 mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                            {{#if (eq this.status 'delivered')}}
                                <button class="btn btn-outline btn-sm" onclick="event.preventDefault(); event.stopPropagation(); reorder('{{this.id}}')">
                                    <span class="material-symbols-outlined text-sm mr-1">replay</span>
                                    Reorder
                                </button>
                                <button class="btn btn-outline btn-sm" onclick="event.preventDefault(); event.stopPropagation(); writeReview('{{this.id}}')">
                                    <span class="material-symbols-outlined text-sm mr-1">star</span>
                                    Write Review
                                </button>
                            {{else if (eq this.status 'processing')}}
                                <button class="btn btn-outline btn-sm" onclick="event.preventDefault(); event.stopPropagation(); trackOrder('{{this.id}}')">
                                    <span class="material-symbols-outlined text-sm mr-1">local_shipping</span>
                                    Track Order
                                </button>
                            {{/if}}
                            <button class="btn btn-outline btn-sm" onclick="event.preventDefault(); event.stopPropagation(); downloadInvoice('{{this.id}}')">
                                <span class="material-symbols-outlined text-sm mr-1">download</span>
                                Invoice
                            </button>
                        </div>
                    </a>
                </div>
            {{else}}
                <div class="card p-12 text-center">
                    <span class="material-symbols-outlined text-6xl text-gray-300 dark:text-gray-600 mb-4">receipt_long</span>
                    <h3 class="text-xl font-semibold text-text-headings dark:text-text-headings-dark mb-2">No orders yet</h3>
                    <p class="text-text-light dark:text-text-dark mb-6">Start shopping to see your orders here</p>
                    <a href="/products" class="btn btn-primary">
                        Browse Products
                    </a>
                </div>
            {{/each}}
        </div>

        <!-- Pagination -->
        {{#if pagination}}
            <div class="mt-8 flex items-center justify-center gap-2">
                {{#if pagination.hasPrev}}
                    <a href="?page={{pagination.prevPage}}" class="btn btn-outline">
                        <span class="material-symbols-outlined">chevron_left</span>
                    </a>
                {{/if}}

                {{#each pagination.pages}}
                    <a href="?page={{this.number}}" class="btn {{#if this.active}}btn-primary{{else}}btn-outline{{/if}}">
                        {{this.number}}
                    </a>
                {{/each}}

                {{#if pagination.hasNext}}
                    <a href="?page={{pagination.nextPage}}" class="btn btn-outline">
                        <span class="material-symbols-outlined">chevron_right</span>
                    </a>
                {{/if}}
            </div>
        {{/if}}
    </div>
</main>

{{> footer}}

<script>
function reorder(orderId) {
    if (!confirm('Add all items from this order to your cart?')) return;

    fetch(`/api/orders/${orderId}/reorder`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = '/cart';
        } else {
            alert('Error reordering');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error reordering');
    });
}

function trackOrder(orderId) {
    window.location.href = `/orders/${orderId}#tracking`;
}

function writeReview(orderId) {
    window.location.href = `/orders/${orderId}#reviews`;
}

function downloadInvoice(orderId) {
    window.location.href = `/api/orders/${orderId}/invoice`;
}
</script>
